{% extends "layout.html" %}

{% block title %}Conversation View - Admin{% endblock %}

{% block content %}
<h2>Conversation between Users</h2>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('admin_reports_page') }}" style="margin-right: 10px;">← Back to Reports</a>
    <a href="{{ url_for('admin_dashboard') }}">Back to Dashboard</a>
</div>

<div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <div>
            <h3 style="margin-bottom: 5px;">User A</h3>
            <p style="margin: 0;">
                <strong>Email:</strong> 
                {% if user_a and user_a.email %}
                    {{ user_a.email }}
                {% else %}
                    User ID: {{ user_a_id }}
                {% endif %}
                <br>
                <strong>Username:</strong> 
                {% if user_a and user_a.username %}
                    {{ user_a.username }}
                {% else %}
                    N/A
                {% endif %}
                <br>
                <a href="{{ url_for('profile', user_id=user_a_id) }}">View Profile</a>
            </p>
        </div>
        <div>
            <h3 style="margin-bottom: 5px;">User B</h3>
            <p style="margin: 0;">
                <strong>Email:</strong> 
                {% if user_b and user_b.email %}
                    {{ user_b.email }}
                {% else %}
                    User ID: {{ user_b_id }}
                {% endif %}
                <br>
                <strong>Username:</strong> 
                {% if user_b and user_b.username %}
                    {{ user_b.username }}
                {% else %}
                    N/A
                {% endif %}
                <br>
                <a href="{{ url_for('profile', user_id=user_b_id) }}">View Profile</a>
            </p>
        </div>
    </div>
    
    {% if report_info %}
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #856404;">Report Information</h4>
        <p><strong>Report ID:</strong> {{ report_info.id }}</p>
        <p><strong>Reported by:</strong> 
            {% if report_info.reporter and report_info.reporter.email %}
                {{ report_info.reporter.email }}
            {% else %}
                User ID: {{ report_info.reporter_id }}
            {% endif %}
        </p>
        <p><strong>Reason:</strong> {{ report_info.reason or 'No reason provided' }}</p>
        <p><strong>Status:</strong> 
            {% if report_info.status == 'open' %}
            <span style="background: orange; color: white; padding: 4px 8px; border-radius: 4px;">
                {{ report_info.status }}
            </span>
            {% else %}
            <span style="background: green; color: white; padding: 4px 8px; border-radius: 4px;">
                {{ report_info.status }}
            </span>
            {% endif %}
        </p>
        {% if report_info.message_snapshot %}
        <p><strong>Reported Message:</strong> {{ report_info.message_snapshot }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<div style="background: white; border-radius: 8px; padding: 20px;">
    <h3 style="margin-top: 0;">Conversation</h3>
    
    {% if messages and messages|length > 0 %}
    <div style="max-height: 600px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 6px;">
        {% for message in messages %}
        <div style="margin-bottom: 16px;">
            {% if message.sender_id == user_a_id %}
            <div style="display: flex; justify-content: flex-start;">
                <div style="max-width: 70%;">
                    <div style="background: #e3f2fd; color: #333; padding: 12px 16px; border-radius: 18px; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 4px;">{{ message.body }}</div>
                        <div style="font-size: 12px; opacity: 0.7; text-align: right;">
                            {{ message.created_at|datetime_format }}
                            (User A)
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="display: flex; justify-content: flex-end;">
                <div style="max-width: 70%;">
                    <div style="background: #007bff; color: white; padding: 12px 16px; border-radius: 18px; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 4px;">{{ message.body }}</div>
                        <div style="font-size: 12px; opacity: 0.7; text-align: right;">
                            {{ message.created_at|datetime_format }}
                            (User B)
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 6px;">
        <p style="color: #6c757d;">No messages found in this conversation.</p>
    </div>
    {% endif %}
</div>

<div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    {% if report_info %}
    <form method="post" action="{{ url_for('admin_resolve_report', report_id=report_info.id) }}" style="display: inline;">
        <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Mark Report as Resolved
        </button>
    </form>
    {% endif %}
    
    <form method="post" action="{{ url_for('admin_ban_user', user_id=user_a_id) }}" style="display: inline;">
        <input type="hidden" name="days" value="7">
        <button type="submit" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Ban User A (7 days)
        </button>
    </form>
    
    <form method="post" action="{{ url_for('admin_ban_user', user_id=user_b_id) }}" style="display: inline;">
        <input type="hidden" name="days" value="7">
        <button type="submit" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Ban User B (7 days)
        </button>
    </form>
    
    <form method="post" action="{{ url_for('admin_delete_conversation') }}" style="display: inline;">
        <input type="hidden" name="user_a_id" value="{{ user_a_id }}">
        <input type="hidden" name="user_b_id" value="{{ user_b_id }}">
        <button type="submit" onclick="return confirm('Are you sure you want to delete this entire conversation? This cannot be undone.');"
                style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Delete Conversation
        </button>
    </form>
</div>

<div style="margin-top: 20px;">
    <h4>Send Warning</h4>
    <div style="display: flex; gap: 10px;">
        <form method="post" action="{{ url_for('admin_send_warning') }}">
            <input type="hidden" name="user_id" value="{{ user_a_id }}">
            <input type="hidden" name="message" value="⚠️ WARNING: Your conversation behavior has been flagged.">
            <button type="submit" style="background: #ffc107; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                Warn User A
            </button>
        </form>
        
        <form method="post" action="{{ url_for('admin_send_warning') }}">
            <input type="hidden" name="user_id" value="{{ user_b_id }}">
            <input type="hidden" name="message" value="⚠️ WARNING: Your conversation behavior has been flagged.">
            <button type="submit" style="background: #ffc107; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                Warn User B
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Auto-scroll to bottom of conversation
document.addEventListener('DOMContentLoaded', function() {
    var container = document.querySelector('div[style*="max-height: 600px"]');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});
</script>
{% endblock %}