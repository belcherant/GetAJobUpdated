{% extends "layout.html" %}

{% block title %}Applicants — {{ job.title }}{% endblock %}

{% block content %}
<h2 style="color:var(--primary); margin-bottom:6px;">{{ job.title }} — Applicants</h2>
<p class="meta" style="color:#666; margin-bottom:12px;">
  Below are the applications for this job. Click Message to start a conversation with an applicant!
</p>

<div class="card" style="max-width:980px; margin-top:6px;">
  {% if applications and applications|length > 0 %}
    <ul style="list-style:none; padding:0; margin:0;">
      {% for app in applications %}
        <li style="padding:14px 0; border-bottom:1px solid #eee; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;">
          <div style="flex:1; min-width:0;">
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              {# Applicant display name: prefer username if available, otherwise email #}
              {% set applicant_display = (app.applicant_username if app.applicant_username is defined and app.applicant_username else (app.applicant_email if app.applicant_email is defined else 'Applicant')) %}
              <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis;">
                {# Link to the applicant's public profile #}
                {% if app.user_id is defined %}
                  <a href="{{ url_for('profile', user_id=app.user_id) }}">{{ applicant_display }}</a>
                {% else %}
                  {{ applicant_display }}
                {% endif %}
              </div>
              <div class="small text-muted">• Applied: {{ app.created_at|date_only }}</div>
            </div>

            {% if app.cover_letter %}
              <div style="margin-top:8px; color:#333;">
                <strong>Cover letter (text)</strong>
                <div style="margin-top:6px;">{{ app.cover_letter[:400] }}{% if app.cover_letter and app.cover_letter|length > 400 %}...{% endif %}</div>
              </div>
            {% endif %}

            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              {# Serve uploaded PDFs from the /uploads/<filename> route.
                 Extract basename from stored path (handles legacy paths) #}
              {% if app.cover_letter_path %}
                {% set cl_filename = app.cover_letter_path.split('/')[-1].split('\\')[-1] %}
                <a class="btn btn-outline" href="{{ url_for('uploaded_file', filename=cl_filename) }}" target="_blank" rel="noopener">View cover letter (PDF)</a>
              {% endif %}

              {% if app.resume_path %}
                {% set res_filename = app.resume_path.split('/')[-1].split('\\')[-1] %}
                <a class="btn btn-outline" href="{{ url_for('uploaded_file', filename=res_filename) }}" target="_blank" rel="noopener">View resume (PDF)</a>
              {% endif %}

              {# Optionally show a View Profile button if we have the applicant id #}
              {% if app.user_id is defined %}
                <a class="btn btn-outline" href="{{ url_for('profile', user_id=app.user_id) }}">View profile</a>
              {% endif %}
            </div>
          </div>

          <div style="width:160px; text-align:right; flex-shrink:0;">
            {# Link to messages UI with other_id set to applicant user id (if available) #}
            {% if app.user_id is defined %}
              <a class="btn btn-outline" href="{{ url_for('messages_page') }}?other_id={{ app.user_id }}">Message</a>
            {% else %}
              <a class="btn btn-outline disabled" href="#" aria-disabled="true">Message</a>
            {% endif %}
            <div style="margin-top:10px; color:var(--muted); font-size:0.92rem;">Application ID: {{ app.id }}</div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div style="padding:18px; color:var(--muted);">No applicants yet for this job.</div>
  {% endif %}
</div>
{% endblock %}