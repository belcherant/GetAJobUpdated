{% extends "layout.html" %}

{% block content %}
<h2>Admin â€” Reviews for {{ user.email }}</h2>

<p>
  Role: <strong>{{ user.role }}</strong>
  {% if user.is_banned %}<span style="color:#c00; margin-left:12px;">BANNED{% if user.banned_until %} until {{ user.banned_until }}{% endif %}</span>{% endif %}
</p>

<h3>User ratings (ratings about this account)</h3>
<p>Average: {% if avg_user.avg %}{{ avg_user.avg|round(2) }} ({{ avg_user.count }} reviews){% else %}No ratings{% endif %}</p>

{% if user_ratings and user_ratings|length > 0 %}
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="border-bottom:1px solid #ccc;">
        <th style="padding:8px;">ID</th>
        <th style="padding:8px;">Rater</th>
        <th style="padding:8px;">Rating</th>
        <th style="padding:8px;">Comment</th>
        <th style="padding:8px;">When</th>
        <th style="padding:8px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in user_ratings %}
        <tr style="border-bottom:1px solid #eee;">
          <td style="padding:8px;">{{ r.id }}</td>
          <td style="padding:8px;">{{ r.rater_email or r.rater_id }}</td>
          <td style="padding:8px;">{{ r.rating }}</td>
          <td style="padding:8px;">{{ r.comment }}</td>
          <td style="padding:8px;">{{ r.created_at }}</td>
          <td style="padding:8px;">
            <form method="post" action="{{ url_for('admin_delete_rating', rating_id=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete rating?');">
              <button type="submit" style="background:none;border:none;color:#c00;cursor:pointer;padding:0;">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="empty">No user ratings found.</div>
{% endif %}

<h3 style="margin-top:24px;">Job ratings for jobs posted by {{ user.email }}</h3>
{% if jobs and jobs|length > 0 %}
  {% for job in jobs %}
    <div style="border:1px solid #eee; padding:12px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong><a href="{{ url_for('job_detail', job_id=job.id) }}">{{ job.title }}</a></strong>
          <div style="color:#666; font-size:13px;">{{ job.location_text or '' }}</div>
        </div>
        <div style="text-align:right;">
          Avg: {% if jobs_avg[job.id].avg %}{{ jobs_avg[job.id].avg|round(2) }} ({{ jobs_avg[job.id].count }}){% else %}No ratings{% endif %}
        </div>
      </div>

      {% set jr = job_ratings_map[job.id] %}
      {% if jr and jr|length > 0 %}
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr style="border-bottom:1px solid #ccc;">
              <th style="padding:6px;">ID</th>
              <th style="padding:6px;">Rater</th>
              <th style="padding:6px;">Rating</th>
              <th style="padding:6px;">Comment</th>
              <th style="padding:6px;">When</th>
              <th style="padding:6px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for rr in jr %}
              <tr style="border-bottom:1px solid #eee;">
                <td style="padding:6px;">{{ rr.id }}</td>
                <td style="padding:6px;">{{ rr.rater_email or rr.rater_id }}</td>
                <td style="padding:6px;">{{ rr.rating }}</td>
                <td style="padding:6px;">{{ rr.comment }}</td>
                <td style="padding:6px;">{{ rr.created_at }}</td>
                <td style="padding:6px;">
                  <form method="post" action="{{ url_for('admin_delete_rating', rating_id=rr.id) }}" style="display:inline;" onsubmit="return confirm('Delete rating?');">
                    <button type="submit" style="background:none;border:none;color:#c00;cursor:pointer;padding:0;">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty" style="margin-top:8px;">No ratings for this job.</div>
      {% endif %}
    </div>
  {% endfor %}
{% else %}
  <div class="empty">This user has not posted any jobs.</div>
{% endif %}

<p><a href="{{ url_for('admin_dashboard') }}">Back to users</a></p>
{% endblock content %}