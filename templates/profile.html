{% extends "layout.html" %}

{# Compute a safe display name: prefer username, fall back to first+last (handling None), then email #}
{% set safe_first = user.first_name|default('', true) %}
{% set safe_last = user.last_name|default('', true) %}
{% set full_name = (safe_first ~ ' ' ~ safe_last)|trim %}
{% set display_name = user.username or full_name or user.email %}

{% block title %}{{ display_name }} — Profile{% endblock %}

{% block content %}
<div class="card" style="max-width:820px; margin:0 auto; background:#fff; padding:18px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.04);">
  <h2>{{ display_name }}</h2>
  <div class="meta" style="color:#666; margin-top:6px;">
    Role: <strong>{{ role_display(user.role) }}</strong>
    {% if full_name %} • Name: {{ full_name }}{% endif %}
  </div>

  <hr>

  <h3>About</h3>
  <p>Email: {{ user.email }}</p>

  <div style="margin-top:12px;">
    <strong>Average rating:</strong>
    {% if avg_rating %}
      <span style="font-weight:700; color:var(--primary);">{{ "%.2f"|format(avg_rating) }} / 5</span>
    {% else %}
      <span class="small text-muted">No ratings yet</span>
    {% endif %}
  </div>

  {% if current_user.is_authenticated and (current_user.get_id()|int) != (user.id|int) %}
    <form method="post" action="{{ url_for('rate_user', user_id=user.id) }}" style="margin-top:12px;">
      <label for="rating">Leave a rating</label>
      <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
        <select id="rating" name="rating" required style="padding:8px; border-radius:6px;">
          <option value="">Rating — 1 (worst) to 5 (best)</option>
          <option value="5">5 — Excellent</option>
          <option value="4">4 — Good</option>
          <option value="3">3 — Okay</option>
          <option value="2">2 — Poor</option>
          <option value="1">1 — Terrible</option>
        </select>
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>

      <label for="comment" style="margin-top:10px; display:block;">Comment (optional)</label>
      <textarea id="comment" name="comment" rows="3" style="width:100%; padding:8px; border-radius:6px; border:1px solid #e6e6e6;"></textarea>
    </form>
  {% elif current_user.is_authenticated %}
    <div class="small text-muted" style="margin-top:12px;">You cannot review/rate yourself.</div>
  {% endif %}

  {% if ratings %}
    <hr style="margin-top:18px;">
    <h3>Ratings</h3>
    <ul style="list-style:none; padding:0; margin:0;">
      {% for r in ratings %}
        <li style="padding:10px 0; border-bottom:1px solid #f2f2f2;">
          <div style="display:flex; gap:8px; align-items:flex-start;">
            <div style="flex:1;">
              <div style="font-weight:700;">{{ r.rating }} / 5</div>
              <div style="color:#666; font-size:0.9rem;">{{ r.comment }}</div>
              <div class="meta" style="color:#999; font-size:0.85rem; margin-top:6px;">By {{ r.rater_email or ('User ' ~ r.rater_id) }} • {{ r.created_at|date_only }}</div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</div>
{% endblock %}